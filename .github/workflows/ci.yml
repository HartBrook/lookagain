name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  validate:
    name: Validate Plugin Structure
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate plugin.json
        run: |
          if ! python3 -c "import json; json.load(open('src/dot-claude-plugin/plugin.json'))"; then
            echo "Error: plugin.json is not valid JSON"
            exit 1
          fi
          echo "plugin.json is valid"

      - name: Check required files exist
        run: |
          required_files=(
            "src/dot-claude-plugin/plugin.json"
            "src/commands/lookagain.md"
            "src/agents/lookagain-reviewer.md"
            "src/skills/lookagain-output-format/SKILL.md"
            "README.md"
            "LICENSE"
            "CHANGELOG.md"
          )

          missing=0
          for file in "${required_files[@]}"; do
            if [[ ! -f "$file" ]]; then
              echo "Missing: $file"
              missing=1
            else
              echo "Found: $file"
            fi
          done

          if [[ $missing -eq 1 ]]; then
            exit 1
          fi

      - name: Validate plugin.json references
        run: |
          # Check that referenced commands, agents, skills exist
          commands=$(python3 -c "import json; print('\n'.join(json.load(open('src/dot-claude-plugin/plugin.json')).get('commands', [])))")
          agents=$(python3 -c "import json; print('\n'.join(json.load(open('src/dot-claude-plugin/plugin.json')).get('agents', [])))")
          skills=$(python3 -c "import json; print('\n'.join(json.load(open('src/dot-claude-plugin/plugin.json')).get('skills', [])))")

          errors=0

          for cmd in $commands; do
            if [[ ! -f "src/commands/$cmd.md" ]]; then
              echo "Error: Command '$cmd' referenced but src/commands/$cmd.md not found"
              errors=1
            fi
          done

          for agent in $agents; do
            if [[ ! -f "src/agents/$agent.md" ]]; then
              echo "Error: Agent '$agent' referenced but src/agents/$agent.md not found"
              errors=1
            fi
          done

          for skill in $skills; do
            if [[ ! -f "src/skills/$skill/SKILL.md" ]]; then
              echo "Error: Skill '$skill' referenced but src/skills/$skill/SKILL.md not found"
              errors=1
            fi
          done

          if [[ $errors -eq 1 ]]; then
            exit 1
          fi

          echo "All plugin.json references are valid"

      - name: Test package script
        run: |
          chmod +x scripts/package.sh
          ./scripts/package.sh

          # Verify output structure
          if [[ ! -d "dist/lookagain/.claude" ]]; then
            echo "Error: dist/lookagain/.claude not created"
            exit 1
          fi

          if [[ ! -d "dist/lookagain/.claude-plugin" ]]; then
            echo "Error: dist/lookagain/.claude-plugin not created"
            exit 1
          fi

          if ! ls dist/lookagain-v*.zip 1>/dev/null 2>&1; then
            echo "Error: zip archive not created"
            exit 1
          fi

          echo "Package script completed successfully"
